From f5815da5fb767c99892d2b51e6bbf3a7375da0b7 Mon Sep 17 00:00:00 2001
From: "H.J. Lu" <hjl.tools@gmail.com>
Date: Tue, 19 May 2020 05:24:21 -0700
Subject: [PATCH] Apply Fix java script

---
 0001-Fix-java-script.patch | 26 ++++++++++++++++++++++++++
 kernel.spec                |  3 +++
 2 files changed, 29 insertions(+)
 create mode 100644 0001-Fix-java-script.patch

diff --git a/0001-Fix-java-script.patch b/0001-Fix-java-script.patch
new file mode 100644
index 000000000..838379ebb
--- /dev/null
+++ b/0001-Fix-java-script.patch
@@ -0,0 +1,26 @@
+From 1ec156ca86c3c9a5dcd2994ffdcb5ed8fc6c2a6e Mon Sep 17 00:00:00 2001
+From: Yu-cheng Yu <yu-cheng.yu@intel.com>
+Date: Mon, 18 May 2020 16:14:27 -0700
+Subject: [PATCH] Fix java script.
+
+---
+ arch/x86/kernel/fpu/signal.c | 3 ++-
+ 1 file changed, 2 insertions(+), 1 deletion(-)
+
+diff --git a/arch/x86/kernel/fpu/signal.c b/arch/x86/kernel/fpu/signal.c
+index a85dd7824021..43e4464674c2 100644
+--- a/arch/x86/kernel/fpu/signal.c
++++ b/arch/x86/kernel/fpu/signal.c
+@@ -109,7 +109,8 @@ static int get_cet_from_sigframe(int ia32, void __user *fp, struct sc_ext *ext)
+ 		if (ext->total_size != sizeof(*ext))
+ 			return -EFAULT;
+ 
+-		err = cet_verify_rstor_token(ia32, ext->ssp, &ext->ssp);
++		if (current->thread.cet.shstk_size)
++			err = cet_verify_rstor_token(ia32, ext->ssp, &ext->ssp);
+ 	}
+ 
+ 	return err;
+-- 
+2.21.0
+
diff --git a/kernel.spec b/kernel.spec
index 06f99a9ca..81612bddd 100644
--- a/kernel.spec
+++ b/kernel.spec
@@ -48,6 +48,8 @@ Patch200045: 0045-x86-Disallow-vsyscall-emulation-when-CET-is-enabled.patch
 Patch200046: 0046-powerpc-Keep-.rela-sections-when-CONFIG_RELOCATABLE-.patch
 Patch200047: 0047-Discard-.note.gnu.property-sections-in-generic-NOTES.patch
 
+Patch300001: 0001-Fix-java-script.patch
+
 # We have to override the new %%install behavior because, well... the kernel is special.
 %global __spec_install_pre %{___build_pre}
 
@@ -1460,6 +1462,7 @@ ApplyOptionalPatch 0044-x86-vdso-Insert-endbr32-endbr64-to-vDSO.patch
 ApplyOptionalPatch 0045-x86-Disallow-vsyscall-emulation-when-CET-is-enabled.patch
 ApplyOptionalPatch 0046-powerpc-Keep-.rela-sections-when-CONFIG_RELOCATABLE-.patch
 ApplyOptionalPatch 0047-Discard-.note.gnu.property-sections-in-generic-NOTES.patch
+ApplyOptionalPatch 0001-Fix-java-script.patch
 
 # END OF PATCH APPLICATIONS
 
-- 
2.26.2

