From a6a764f6eb760bfb78bd63b604cc2bf55985ed02 Mon Sep 17 00:00:00 2001
From: "H.J. Lu" <hjl.tools@gmail.com>
Date: Wed, 1 Jul 2020 07:48:55 -0700
Subject: [PATCH] Update 0029 x86/cet/shstk: User-mode shadow stack support for
 v5.7.7

---
 ...et-shstk-User-mode-shadow-stack-support.patch | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/0029-x86-cet-shstk-User-mode-shadow-stack-support.patch b/0029-x86-cet-shstk-User-mode-shadow-stack-support.patch
index 1af57d6ec..60a757138 100644
--- a/0029-x86-cet-shstk-User-mode-shadow-stack-support.patch
+++ b/0029-x86-cet-shstk-User-mode-shadow-stack-support.patch
@@ -1,4 +1,4 @@
-From ca1a609ee448e93b86809cc383bbcac891c9f841 Mon Sep 17 00:00:00 2001
+From 433eacf3d198be8443afd432d15b40cc77f2f761 Mon Sep 17 00:00:00 2001
 From: Yu-cheng Yu <yu-cheng.yu@intel.com>
 Date: Thu, 22 Aug 2019 10:06:11 -0700
 Subject: [PATCH 29/47] x86/cet/shstk: User-mode shadow stack support
@@ -99,7 +99,7 @@ index 4ea8584682f9..a0e1b24cfa02 100644
  #define DISABLED_MASK18	0
  #define DISABLED_MASK_CHECK BUILD_BUG_ON_ZERO(NCAPINTS != 19)
 diff --git a/arch/x86/include/asm/processor.h b/arch/x86/include/asm/processor.h
-index eb9536f803f9..0ccf1c7ab173 100644
+index 8352075b0435..2a11fd08b9f6 100644
 --- a/arch/x86/include/asm/processor.h
 +++ b/arch/x86/include/asm/processor.h
 @@ -27,6 +27,7 @@ struct vm86;
@@ -110,7 +110,7 @@ index eb9536f803f9..0ccf1c7ab173 100644
  
  #include <linux/personality.h>
  #include <linux/cache.h>
-@@ -543,6 +544,10 @@ struct thread_struct {
+@@ -544,6 +545,10 @@ struct thread_struct {
  
  	unsigned int		sig_on_uaccess_err:1;
  
@@ -276,7 +276,7 @@ index 000000000000..d8196c8e792a
 +	cet->shstk_size = 0;
 +}
 diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.c
-index bed0cb83fe24..1563b472e0f9 100644
+index c669a5756bdf..034372825cbf 100644
 --- a/arch/x86/kernel/cpu/common.c
 +++ b/arch/x86/kernel/cpu/common.c
 @@ -55,6 +55,7 @@
@@ -285,9 +285,9 @@ index bed0cb83fe24..1563b472e0f9 100644
  #include <asm/cpu_device_id.h>
 +#include <asm/cet.h>
  #include <asm/uv/uv.h>
+ #include <asm/resctrl_sched.h>
  
- #include "cpu.h"
-@@ -469,6 +470,32 @@ static __init int setup_disable_pku(char *arg)
+@@ -470,6 +471,32 @@ static __init int setup_disable_pku(char *arg)
  __setup("nopku", setup_disable_pku);
  #endif /* CONFIG_X86_64 */
  
@@ -320,7 +320,7 @@ index bed0cb83fe24..1563b472e0f9 100644
  /*
   * Some CPU features depend on higher CPUID levels, which may not always
   * be available due to CPUID level capping or broken virtualization
-@@ -1505,6 +1532,7 @@ static void identify_cpu(struct cpuinfo_x86 *c)
+@@ -1515,6 +1542,7 @@ static void identify_cpu(struct cpuinfo_x86 *c)
  	x86_init_rdrand(c);
  	x86_init_cache_qos(c);
  	setup_pku(c);
@@ -329,7 +329,7 @@ index bed0cb83fe24..1563b472e0f9 100644
  	/*
  	 * Clear/Set all flags overridden by options, need do it
 diff --git a/arch/x86/kernel/process.c b/arch/x86/kernel/process.c
-index ce6cd220f722..56587051df5a 100644
+index 764b44206d4a..b1cbe01d8904 100644
 --- a/arch/x86/kernel/process.c
 +++ b/arch/x86/kernel/process.c
 @@ -42,6 +42,7 @@
-- 
2.26.2

